{% extends 'base_layout.html' %}

{% block content %}
<div class="container" style="margin-top: 20px; font-family: 'Arial', sans-serif; background-color: rgba(255, 255, 255, 0.2); padding: 2px 0;">

    <!-- Exibe a mensagem de sucesso, se houver -->
    {% if messages %}
    <ul class="messages" style="max-width: 600px; margin: 70px auto; list-style: none; padding: 0; text-align: center;">
        {% for message in messages %}
        <li class="message-item" style="background-color: rgb(204, 131, 113); color: white; padding: 10px 15px; margin-bottom: 10px; border-radius: 10px;">
            {{ message }}
        </li>
        {% endfor %}
    </ul>
    <script>
        setTimeout(function () {
            const messageItems = document.querySelectorAll('.message-item');
            messageItems.forEach(function (item) {
                item.style.display = 'none';
            });
        }, 5000);
    </script>
    {% endif %}

    <h1 class="text-center" style="margin-bottom: 50px; font-size: 40px; color: #ffffff;">Individual Patient Page</h1>

    <!-- Informações do Paciente -->
    <div class="patient-info" style="margin-bottom: 60px;">
        <div class="card" style="padding: 20px 30px; border-radius: 10px; background-color: #464444; max-width: 600px; margin: 0 auto;">
            <div class="card-header" style="font-size: 22px; font-weight: 600; margin-bottom: 25px; color: #c4bebe;">
                Informations
            </div>
            <div class="card-body" style="line-height: 2; font-size: 16px;">
                <p><strong style="color: #c4bebe;">Patient name:</strong> <span style="color: #c4bebe;">{{ paciente.name }}</span></p>
                <p><strong style="color: #c4bebe;">Patient number:</strong> <span style="color: #c4bebe;">{{ paciente.number }}</span></p>

                <!-- Informações adicionais -->
                {% if paciente.patientinfo_set.exists %}
                <div class="additional-infos" style="margin-top: 30px;">
                    <h4 style="font-size: 22px; font-weight: 600; margin-bottom: 20px; color: #c4bebe;">Additional Information:</h4>
                    <ul style="list-style: none; padding: 0;">
                        {% for info in paciente.patientinfo_set.all %}
                        <li id="info-item-{{ info.id }}" style="color: #c4bebe; line-height: 1.7; font-size: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>{{ info.title }}:</strong> {{ info.description }}
                            </div>
                            <button onclick="removeInfo('{{ info.id }}')" style="background-color: #8f3b37; color: white; border: none; border-radius: 10px; padding: 5px 15px; cursor: pointer;">
                                Remove
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Botão Add Information -->
                <div id="add-info-btn-container" style="margin-top: 30px; text-align: center;">
                    <button id="add-info-btn" onclick="toggleForm()" style="padding: 12px 30px; background-color:  rgb(204, 131, 113); color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease;">
                        Add Information
                    </button>
                </div>

                <!-- Formulário para adicionar informações (inicialmente escondido) -->
                <div id="add-info-form" style="display: none; margin-top: 40px;">
                    <form method="post" action="{% url 'accounts:add_patient_info' paciente.id %}">
                        {% csrf_token %}
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label for="info-title" style="color: #c4bebe; font-size: 16px;">Title</label>
                            <input type="text" id="info-title" name="title" class="form-control" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;" required>
                        </div>

                        <div class="form-group" style="margin-bottom: 25px;">
                            <label for="info-description" style="color: #c4bebe; font-size: 16px;">Description</label>
                            <textarea id="info-description" name="description" rows="5" class="form-control" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;" required></textarea>
                        </div>

                        <button type="submit" style="margin-top: 25px; padding: 12px 30px; background-color:  rgb(204, 131, 113); color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease;">
                            Save Information
                        </button>

                        <!-- Botão Cancel -->
                        <button type="button" onclick="cancelForm()" style="margin-top: 25px; padding: 12px 30px; background-color: #8f3b37; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; margin-left: 15px;">
                            Cancel
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload da Radiografia -->
    <div class="upload-section" style="margin-bottom: 80px; text-align: center;">
        <h3 style="font-size: 24px; color: #383737; font-weight: 600; margin-bottom: 30px;">Upload X-Ray</h3>
        <p style="font-size: 16px; color: #c4bebe; margin-bottom: 40px; max-width: 500px; margin: 0 auto;">Upload an X-Ray for analysis. The system uses AI to detect possible signs of cancer, helping with the diagnosis.</p>

        <div class="upload-container" style="background-color: #464444; border-radius: 10px; padding: 30px; width: 100%; max-width: 450px; margin: 0 auto;">
            <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'accounts:upload_image' paciente.id %}">
                {% csrf_token %}
                <div class="upload-box" id="upload-box" style="border: 2px dashed  rgb(204, 131, 113); padding: 20px; text-align: center; position: relative; border-radius: 10px; background-color: #ebe5e5; cursor: pointer;">
                    <span id="upload-instruction" style="font-size: 14px; color:  rgb(204, 131, 113);">Drag your X-Ray here or click to select</span>
                    <input id="upload-image" type="file" name="image" accept="image/*" onchange="previewImage(event)" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0; cursor: pointer;">
                    <div id="image-preview" class="image-preview" style="margin-top: 20px;"></div>
                </div>
                <button type="submit" style="margin-top: 25px; padding: 12px 30px; background-color:  rgb(204, 131, 113); color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease;">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Imagens Carregadas -->
    <div class="uploaded-images" style="margin-bottom: 100px; text-align: center;">
        <h3 style="font-size: 24px; color: #383737; font-weight: 600; margin-bottom: 30px;">Uploaded X-Rays</h3>
        {% if images %}
        <div class="image-gallery" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
            {% for image in images %}
            <div class="image-card" id="image-card-{{ image.id }}" style="text-align: center; width: 200px; position: relative; border-radius: 10px; overflow: hidden; background-color: #464444;">
                <img src="{{ image.image.url }}" alt="{{ image.description }}" class="image-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
                <p style="font-size: 14px; color: #c4bebe; margin: 10px 0;">{{ image.description }}</p>
        
                <!-- Botão X para remover a imagem -->
                <span class="remove-image" onclick="showDeleteModal('{{ image.id }}')" style="position: absolute; top: 10px; right: 10px; cursor: pointer; background-color: #8f3b37; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; font-size: 14px;">
                    X
                </span>
                
                <!-- Modal de Confirmação -->
                <div id="deleteModal-{{ image.id }}" class="modal" style="display:none;">
                    <div class="modal-content">
                        <h2 style="color:#000;">Are you sure you want to delete this X-Ray?</h2>
                        <button class="button danger" onclick="deleteImage('{{ image.id }}')">Yes, Delete</button>
                        <button class="button" onclick="cancelDelete('{{ image.id }}')">Cancel</button>
                    </div>
                </div>
                
                <!-- Diagnóstico -->
                <div class="diagnostic" style="padding: 10px 15px; background-color: #464444; border-top: 1px solid #464444; border-radius: 0 0 10px 10px;">
                    <p style="font-size: 14px; color: #c4bebe;">
                        <strong>Diagnosis:</strong> 
                        <span class="diagnostic-result" style="display: none; color: #8f3b37; font-weight: 700;">
                            {% comment %} Para imagens já existentes, o diagnóstico pode não estar disponível {% endcomment %}
                        </span>
                    </p>
                    <button type="button" onclick="toggleDiagnostic(this)" style="background-color:  rgb(204, 131, 113); color: white; font-size: 14px; border: none; border-radius: 20px; padding: 5px 15px; cursor: pointer;">
                        See Diagnosis
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <p style="font-size: 16px; color: #c4bebe; text-align: center;">No images uploaded for this patient</p>
        {% endif %}
    </div>

    <!-- Histórico de Diagnósticos -->
    <div class="diagnostic-history" style="margin-top: 40px; text-align: center;">
        <h3 style="font-size: 24px; color: #413f3f; font-weight: 600; margin-bottom: 30px;">Diagnostic History</h3>
        {% if paciente.diagnoses.exists %}
        <div style="max-width: 600px; margin: 0 auto; text-align: left; background-color: #666363; padding: 20px; border-radius: 10px;">
            <ul style="list-style: none; padding: 0;">
                {% for diagnosis in paciente.diagnoses.all %}
                <li style="color: #c4bebe; line-height: 1.7; margin-bottom: 10px;">
                    <strong>Date:</strong> {{ diagnosis.date }}<br>
                    <strong>Result:</strong> {{ diagnosis.result }}<br>
                    <strong>Notes:</strong> {{ diagnosis.notes }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <p style="font-size: 16px; color: #c4bebe; text-align: center;">No diagnostic history available.</p>
        {% endif %}
    </div>
</div>

<script>
function toggleForm() {
    const form = document.getElementById("add-info-form");
    const button = document.getElementById("add-info-btn");
    form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
    button.style.display = (form.style.display === "block") ? "none" : "block";
}

function cancelForm() {
    const form = document.getElementById("add-info-form");
    const button = document.getElementById("add-info-btn");
    form.style.display = "none";
    button.style.display = "block";
}

function previewImage(event) {
    const preview = document.getElementById("image-preview");
    preview.innerHTML = '';
    const file = event.target.files[0];
    if (file) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.width = "100%";
        preview.appendChild(img);
    }
}

function showDeleteModal(imageId) {
    document.getElementById(`deleteModal-${imageId}`).style.display = 'flex';
}

function cancelDelete(imageId) {
    document.getElementById(`deleteModal-${imageId}`).style.display = 'none';
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function toggleDiagnostic(button) {
    const diagnosticResult = button.parentElement.querySelector(".diagnostic-result");
    if (diagnosticResult.style.display === "none") {
        diagnosticResult.style.display = "inline";
        button.textContent = "Hide Diagnosis";
    } else {
        diagnosticResult.style.display = "none";
        button.textContent = "See Diagnosis";
    }
}

// Intercepta o envio do formulário de upload para enviar a imagem e rodar o modelo
document.getElementById("upload-form").addEventListener("submit", function(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
    })
    .then(response => response.json())
    .then(data => {
        // Espera-se que 'data' contenha: id, image_url, description
        const gallery = document.querySelector(".image-gallery");
        const card = document.createElement("div");
        card.classList.add("image-card");
        card.id = "image-card-" + data.id;
        card.style.cssText = "text-align: center; width: 200px; position: relative; border-radius: 10px; overflow: hidden; background-color: #464444;";
        
        // Cria o elemento da imagem
        const img = document.createElement("img");
        img.src = data.image_url;
        img.alt = data.description || "";
        img.classList.add("image-thumbnail");
        img.style.cssText = "width: 100%; height: 150px; object-fit: cover;";
        card.appendChild(img);
        
        // Adiciona a descrição
        const p = document.createElement("p");
        p.style.cssText = "font-size: 14px; color: #c4bebe; margin: 10px 0;";
        p.textContent = data.description || "";
        card.appendChild(p);
        
        // Botão de remoção
        const removeSpan = document.createElement("span");
        removeSpan.classList.add("remove-image");
        removeSpan.textContent = "X";
        removeSpan.style.cssText = "position: absolute; top: 10px; right: 10px; cursor: pointer; background-color: #8f3b37; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; font-size: 14px;";
        removeSpan.onclick = function() {
            showDeleteModal(data.id);
        };
        card.appendChild(removeSpan);
        
        // Seção de diagnóstico
        const diagnosticDiv = document.createElement("div");
        diagnosticDiv.classList.add("diagnostic");
        diagnosticDiv.style.cssText = "padding: 10px 15px; background-color: #464444; border-top: 1px solid #464444; border-radius: 0 0 10px 10px;";
        const pDiag = document.createElement("p");
        pDiag.style.cssText = "font-size: 14px; color: #c4bebe;";
        pDiag.innerHTML = "<strong>Diagnosis:</strong> <span class='diagnostic-result' style='display: none; color: #8f3b37; font-weight: 700;'></span>";
        diagnosticDiv.appendChild(pDiag);
        const diagButton = document.createElement("button");
        diagButton.type = "button";
        diagButton.textContent = "See Diagnosis";
        diagButton.style.cssText = "background-color:  rgb(204, 131, 113); color: white; font-size: 14px; border: none; border-radius: 20px; padding: 5px 15px; cursor: pointer;";
        diagButton.onclick = function() {
            toggleDiagnostic(diagButton);
        };
        diagnosticDiv.appendChild(diagButton);
        card.appendChild(diagnosticDiv);
        
        if (gallery) {
            gallery.appendChild(card);
        } else {
            const newGallery = document.createElement("div");
            newGallery.classList.add("image-gallery");
            newGallery.style.cssText = "display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;";
            newGallery.appendChild(card);
            const uploadedImagesDiv = document.querySelector(".uploaded-images");
            uploadedImagesDiv.innerHTML = "";
            uploadedImagesDiv.appendChild(newGallery);
        }
        
        // Limpa o input e o preview
        document.getElementById("upload-image").value = "";
        document.getElementById("image-preview").innerHTML = "";
        
        // Executa o modelo automaticamente para a nova imagem
        const diagnosticResultSpan = card.querySelector(".diagnostic-result");
        fetch(`/accounts/run_model/${data.id}`)
            .then(response => response.json())
            .then(modelData => {
                diagnosticResultSpan.textContent = "Previsão: " + modelData.prediction;
                // O resultado permanece oculto até o clique em "See Diagnosis"
            })
            .catch(error => console.error("Erro ao executar o modelo:", error));
    })
    .catch(error => {
        console.error("Erro ao enviar a imagem:", error);
        alert("Error uploading image. Please try again.");
    });
});
</script>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 100%;
}

.button {
    font-size: 14px;
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
}

.button.danger {
    background-color: #485188;
    color: white;
}

.button:hover {
    background-color: #9b9797;
    color: white;
}

.upload-box {
    border: 2px dashed #485188;
    padding: 20px;
    text-align: center;
    position: relative;
    border-radius: 10px;
    background-color: #ebe5e5;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.upload-box:hover {
    background-color: #645f5f;
}
</style>
{% endblock %}
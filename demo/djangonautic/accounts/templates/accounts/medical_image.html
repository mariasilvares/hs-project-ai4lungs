{% extends 'base_layout.html' %}

{% block content %}
<div class="container" style="margin-top: 20px; font-family: 'Arial', sans-serif; background-color: #615c5c; padding: 2px 0;">

    <!-- Exibe a mensagem de sucesso, se houver -->
{% if messages %}
<ul class="messages" style="max-width: 600px; margin: 70px auto; list-style: none; padding: 0; text-align: center;">
    {% for message in messages %}
        <li class="message-item" style="background-color: #485188; color: white; padding: 10px 15px; margin-bottom: 10px; border-radius: 10px;">
            {{ message }}
        </li>
    {% endfor %}
</ul>
<script>
    // Definir o tempo de exibição da mensagem (em milissegundos)
    setTimeout(function() {
        // Selecionar as mensagens e escondê-las
        const messageItems = document.querySelectorAll('.message-item');
        messageItems.forEach(function(item) {
            item.style.display = 'none';
        });
    }, 5000); // 5000ms = 5 segundos
</script>
{% endif %}


    <h1 class="text-center" style="margin-bottom: 30px; font-size: 40px; color: #ffffff;">Individual Patient page</h1>


    <!-- Informações do Paciente -->
    <div class="patient-info" style="margin-bottom: 40px;">
        <div class="card" style="padding: 20px 30px; border-radius: 10px; background-color: #464444; max-width: 600px; margin: 0 auto;">
            <div class="card-header" style="font-size: 22px; font-weight: 600; margin-bottom: 15px; color: #c4bebe;">
                Informations
            </div>
            <div class="card-body" style="line-height: 1.7; font-size: 16px;">
                <p><strong style="color: #c4bebe;">Patient name:</strong> <span style="color: #c4bebe;">{{ paciente.name }}</span></p>
                <p><strong style="color: #c4bebe;">Patient number:</strong> <span style="color: #c4bebe;">{{ paciente.number }}</span></p>
            </div>
        </div>
    </div>

    <!-- Upload da Radiografia -->
    <div class="upload-section" style="margin-bottom: 50px; text-align: center;">
        <h3 style="font-size: 22px; color: #333; font-weight: 600;">Upload X-ray</h3>
        <p style="font-size: 16px; color: #c4bebe; margin-bottom: 30px; max-width: 500px; margin: 0 auto;">Upload an X-ray for analysis. The system uses AI to detect possible signs of cancer, helping with the diagnosis.</p>

        <div class="upload-container" style="background-color: #464444; border-radius: 10px; padding: 30px; width: 100%; max-width: 450px; margin: 0 auto;">
            <form method="post" enctype="multipart/form-data" action="{% url 'accounts:upload_image' paciente.id %}">
                {% csrf_token %}
                <div class="upload-box" id="upload-box" style="border: 2px dashed #485188; padding: 20px; text-align: center; position: relative; border-radius: 10px; background-color: #ebe5e5; cursor: pointer;">
                    <span id="upload-instruction" style="font-size: 14px; color: #485188;">Drag your x-ray here or click to select</span>
                    <input id="upload-image" type="file" name="image" accept="image/*" onchange="previewImage(event)" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0; cursor: pointer;">
                    <div id="image-preview" class="image-preview" style="margin-top: 20px;"></div>
                </div>
                <button type="submit" style="margin-top: 25px; padding: 12px 30px; background-color: #485188; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease;">
                    Send
                </button>
            </form>
        </div>
    </div>

  

    <!-- Imagens Carregadas -->
    <div class="upload-section" style="margin-bottom: 200px; text-align: center;">
        <h3 style="font-size: 22px; color: #333; font-weight: 600;">Uploaded X-rays</h3>
        {% if images %}
            <div class="image-gallery" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                {% for image in images %}
                    <div class="image-card" id="image-card-{{ image.id }}" style="text-align: center; width: 200px; position: relative; border-radius: 10px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); overflow: hidden; background-color: #464444;">
                        <img src="{{ image.image.url }}" alt="{{ image.description }}" class="image-thumbnail" style="width: 100%; height: 150px; object-fit: cover; border-bottom: 1px solid #464444;">
                        <p style="font-size: 14px; color: #444; margin: 10px 0;">{{ image.description }}</p>
                        
                        <!-- Botão X para remover a imagem -->
                        <span class="remove-image" onclick="removeImage('{{ image.id }}')" style="position: absolute; top: 10px; right: 10px; cursor: pointer; background-color: #8f3b37; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; font-size: 14px;">
                            X
                        </span>

                        <!-- Diagnóstico -->
                        <div class="diagnostic" style="padding: 10px 15px; background-color: #464444; border-top: 1px solid #464444; border-radius: 0 0 10px 10px;">
                            <p style="font-size: 14px; color: #c4bebe;"><strong>Diagnosis:</strong> <span class="diagnostic-result" style="display: none; color: #8f3b37;font-weight: 700;">Cancer</span></p>
                            <button type="button" onclick="toggleDiagnostic(this)" style="background-color: #485188; color: white; font-size: 14px; border: none; border-radius: 20px; padding: 5px 15px; cursor: pointer;">
                                See Diagnosis
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="font-size: 16px; color: #c4bebe; text-align: center;">No images uploaded for this patient</p>
        {% endif %}
    </div>

<script>

    
// Função para remover a imagem e também da base de dados
function removeImage(imageId) {
    if (confirm("Are you sure you want to remove this x-ray?")) {
        fetch(`/accounts/delete_image/${imageId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const imageCard = document.querySelector(`#image-card-${imageId}`);
                if (imageCard) {
                    imageCard.remove();
                }
            } else {
                alert("Error removing the x-ray");
            }
        })
        .catch(error => {
            console.error('Error removing the x-ray', error);
            alert("There was an error trying to remove the x-ray");
        });
    }
}

// Função para exibir/ocultar o diagnóstico
function toggleDiagnostic(button) {
    const diagnosticResult = button.previousElementSibling.querySelector('.diagnostic-result');
    if (diagnosticResult.style.display === "none") {
        diagnosticResult.style.display = "inline";
        button.textContent = "Hide Diagnosis";
    } else {
        diagnosticResult.style.display = "none";
        button.textContent = "See Diagnosis";
    }
}
</script>

{% endblock %}